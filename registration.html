<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registration - Durga Pujo 2025 | DeBI e.V.</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .reg-hero {
        background: #b22222;
        color: #fff;
        padding: 80px 20px;
        text-align: center;
      }
      .reg-wrapper {
        max-width: 780px;
        margin: 40px auto;
        background: #fff;
        padding: 35px 30px;
        border-radius: 12px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
      }
      form .field {
        margin-bottom: 18px;
      }
      fieldset {
        border: 1px solid #ddd;
        padding: 18px 20px 22px;
        border-radius: 10px;
        margin-bottom: 24px;
      }
      fieldset legend {
        padding: 0 8px;
        font-weight: 700;
        color: #b22222;
      }
      /* New dropdown-based day selection styles */
      .day-selects {
        display: grid;
        gap: 14px;
        margin-top: 10px;
      }
      .day-select {
        display: flex;
        align-items: center;
        gap: 18px;
      }
      .day-select label {
        flex: 0 0 190px;
        margin: 0;
        font-weight: 600;
        font-size: 14px;
      }
      .day-select select {
        flex: 1;
      }
      form label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .mini-note {
        font-size: 12px;
        color: #555;
        margin-top: 6px;
      }
      form input,
      form select,
      form textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 15px;
        box-sizing: border-box;
      }

      form textarea {
        min-height: 120px;
        resize: vertical;
      }
      .foodpref {
        width: unset;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 15px;
        box-sizing: border-box;
      }
      #paymentAck {
        width: unset;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 15px;
        box-sizing: border-box;
      }
      .inline {
        display: flex;
        gap: 16px;
      }
      .inline .field {
        flex: 1;
      }
      .actions {
        margin-top: 10px;
      }
      .btn {
        background: #b22222;
        color: #fff;
        border: none;
        padding: 12px 26px;
        font-size: 16px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .btn:hover {
        background: #941c1c;
      }
      .btn-secondary {
        background: #666;
        color: #fff;
        margin-right: 12px;
      }
      .btn-secondary:hover {
        background: #4d4d4d;
      }
      .note {
        font-size: 13px;
        color: #555;
        margin-top: 4px;
      }
      .back {
        display: inline-block;
        margin-bottom: 25px;
        text-decoration: none;
        color: #b22222;
        font-weight: 600;
      }
      .back:hover {
        text-decoration: underline;
      }
      .required {
        color: #b22222;
      }
      .success-msg {
        display: none;
        padding: 15px 18px;
        background: #e6ffed;
        border: 1px solid #b2f5c5;
        color: #1f6b3a;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .notif-banner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        box-sizing: border-box;
        padding: 14px 22px 16px;
        background: #143b18;
        color: #fff;
        font-size: 14px;
        line-height: 1.45;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
        z-index: 9999;
        display: none;
        animation: slideDown 0.4s ease;
      }
      .notif-banner.success {
        background: #0f5f30;
      }
      .notif-banner .close-btn {
        position: absolute;
        top: 8px;
        right: 12px;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        line-height: 1;
      }
      .notif-banner a {
        color: #fff;
        text-decoration: underline;
      }
      .notif-banner.error {
        background: #7e1b1b;
      }
      @keyframes slideDown {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .location-map {
        display: block;
        margin: 25px auto 40px;
        max-width: 100%;
        width: 640px;
        height: 420px;
        border: 0;
        border-radius: 10px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.18);
      }
      @media (max-width: 700px) {
        .location-map {
          width: 100%;
          height: 360px;
        }
      }
      /* Responsive adjustments */
      @media (max-width: 760px) {
        .reg-hero {
          padding: 50px 16px 46px;
        }
        .reg-hero h1 {
          font-size: 28px;
          line-height: 1.15;
          margin: 0 0 8px;
        }
        .reg-hero p {
          font-size: 14px;
          margin: 0;
        }
        .reg-wrapper {
          margin: 28px 14px;
          padding: 28px 18px;
        }
        .inline {
          flex-direction: column;
          gap: 4px;
        }
        .day-select {
          flex-direction: column;
          align-items: stretch;
          gap: 6px;
        }
        .day-select label {
          flex: none;
        }
        fieldset {
          padding: 16px 14px 18px;
        }
        form input,
        form select,
        form textarea {
          font-size: 14px;
        }
        .actions {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }
        .actions .btn {
          width: 100%;
        }
        .btn {
          padding: 12px 20px;
          font-size: 15px;
        }
        .btn-secondary {
          margin-right: 0;
        }
        .mini-note {
          font-size: 11px;
        }
        .note {
          font-size: 12px;
        }
        .table-scroll {
          display: none;
        }
      }
      @media (max-width: 480px) {
        .reg-hero h1 {
          font-size: 24px;
        }
        .reg-wrapper {
          margin: 24px 10px;
          padding: 24px 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="reg-hero">
      <h1>Durga Pujo 2025 Registration</h1>
      <p>September 28th – October 2nd | Elbestraße 39, 70376 Stuttgart</p>
    </div>
    <div>
      <h2 style="text-align: center; margin-top: 50px">Location</h2>
      <iframe
        class="location-map"
        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d333921.36229970894!2d8.099914771215836!3d49.16715133432002!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x4799c54253690ced%3A0x2997769acd900aa7!2sElbestra%C3%9Fe%2039%2C%2070376%20Stuttgart!5e0!3m2!1sen!2sde!4v1755413279393!5m2!1sen!2sde"
        allowfullscreen=""
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
        title="Event Location Map"
      ></iframe>
    </div>
    <div class="reg-wrapper">
      <a class="back" href="durga-pujo-2025.html">← Back to Event Page</a>
      <div id="success" class="success-msg" aria-live="polite"></div>
      <form id="regForm" onsubmit="handleSubmit(event)">
        <div class="inline">
          <div class="field">
            <label for="firstName"
              >First Name <span class="required">*</span></label
            >
            <input id="firstName" name="firstName" required />
          </div>
          <div class="field">
            <label for="lastName"
              >Last Name <span class="required">*</span></label
            >
            <input id="lastName" name="lastName" required />
          </div>
        </div>
        <div class="field">
          <label for="email">Email <span class="required">*</span></label>
          <input id="email" name="email" type="email" required />
        </div>
        <div class="inline">
          <div class="field">
            <label for="phone">Phone</label>
            <input id="phone" name="phone" />
          </div>
        </div>
        <fieldset>
          <legend>
            Daily Participation & Meals <span class="required">*</span>
          </legend>
          <p style="margin-top: 0; font-size: 14px; line-height: 1.4">
            Choose an option for each day you plan to attend (leave as None if
            you will not attend that day). Full Day already includes meals.
          </p>
          <div class="day-selects" id="dayOptionsHelp">
            <div class="day-select">
              <label for="shashtiSel">Shashti (Sun 28 Sept)</label>
              <select name="shashti" id="shashtiSel">
                <option value="">None</option>
                <option value="full">Full Day</option>
                <option value="dinner">Dinner</option>
              </select>
            </div>
            <div class="day-select">
              <label for="saptamiSel">Saptami (Mon 29 Sept)</label>
              <select name="saptami" id="saptamiSel">
                <option value="">None</option>
                <option value="full">Full Day</option>
                <option value="lunch">Lunch / Bhog</option>
                <option value="dinner">Dinner</option>
              </select>
            </div>
            <div class="day-select">
              <label for="ashtamiSel">Ashtami (Tue 30 Sept)</label>
              <select name="ashtami" id="ashtamiSel">
                <option value="">None</option>
                <option value="full">Full Day</option>
                <option value="lunch">Lunch / Bhog</option>
                <option value="dinner">Dinner</option>
              </select>
            </div>
            <div class="day-select">
              <label for="nabamiSel">Nabami (Wed 1 Oct)</label>
              <select name="nabami" id="nabamiSel">
                <option value="">None</option>
                <option value="full">Full Day</option>
                <option value="lunch">Lunch / Bhog</option>
                <option value="dinner">Dinner</option>
              </select>
            </div>
            <div class="day-select">
              <label for="dashamiSel">Dashami (Thu 2 Oct)</label>
              <select name="dashami" id="dashamiSel">
                <option value="">None</option>
                <option value="dinner">Lunch</option>
              </select>
            </div>
          </div>
          <div class="mini-note">At least one day selection is required.</div>
        </fieldset>
        <div class="field">
          <label for="adults"
            >Number of Adults Family Members (above 12 years)</label
          >
          <input id="adults" name="adults" type="number" min="1" value="1" />
        </div>
        <div class="field">
          <label for="children">Number of Children (between 6- 12 years)</label>
          <input
            id="children"
            name="children"
            type="number"
            min="0"
            value="0"
          />
        </div>
        <div class="field">
          <label for="children6">Number of Children (below 6 years)</label>
          <input
            id="children6"
            name="children6"
            type="number"
            min="0"
            value="0"
          />
        </div>
        <div class="field">
          <label for="totalCost">Total Cost (estimated)</label>
          <input
            id="totalCost"
            name="totalCost"
            type="text"
            value="€0.00"
            readonly
            style="background: #f9f9f9; font-weight: 600; cursor: not-allowed"
            aria-describedby="totalCostHelp"
          />
          <div id="totalCostHelp" class="mini-note">
            Calculated from selected day options: Adult (Full 29.99 / Lunch
            14.99 / Dinner 24.99) | Child 6–12 (Full 15.99 / Lunch 8.99 / Dinner
            12.99). Child below 6 free.
          </div>
        </div>
        <div class="field">
          <label>Food Preference <span class="required">*</span></label>
          <div style="display: flex; gap: 25px; padding: 6px 2px">
            <label
              style="
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 6px;
              "
            >
              <input
                type="radio"
                name="food_pref"
                value="veg"
                class="foodpref"
                required
              />
              Veg
            </label>
            <label
              style="
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 6px;
              "
            >
              <input
                type="radio"
                name="food_pref"
                value="non-veg"
                class="foodpref"
                required
              />
              Non-Veg
            </label>
          </div>
        </div>
        <div class="field">
          <label for="volunteer">Interested in Volunteering?</label>
          <select id="volunteer" name="volunteer">
            <option>No</option>
            <option>Yes - Decoration</option>
            <option>Yes - Food Service</option>
            <option>Yes - Cultural Program</option>
            <option>Yes - Logistics</option>
          </select>
        </div>
        <div class="field">
          <label for="message"
            >Comments / Cultural Participation Interest</label
          >
          <textarea
            id="message"
            name="message"
            placeholder="E.g., I would like my child to perform a dance, I'm a singer, etc."
          ></textarea>
        </div>
        <div
          class="field"
          style="
            border: 1px solid #f0d9d9;
            padding: 14px 16px;
            border-radius: 8px;
            background: #fff8f8;
          "
        >
          <label style="font-weight: 600; margin-bottom: 8px; display: block"
            >Payment & Cancellation Policy
            <span class="required">*</span></label
          >
          <p style="font-size: 13px; line-height: 1.45; margin: 0 0 8px">
            Please transfer the estimated total amount within
            <strong>72 hours</strong> to confirm your booking. Unpaid
            registrations after 72 hours may be cancelled to free capacity.
          </p>
          <div
            style="
              font-size: 13px;
              background: #faf2f2;
              padding: 10px 12px;
              border-radius: 6px;
              margin: 0 0 10px;
            "
          >
            <strong>Bank Account (DeBI e.V.)</strong><br />
            IBAN: <span id="ibanValue">DE26 1001 8000 0565 6573 12</span><br />
            BIC: <span id="bicValue">FNOMDEB2</span><br />
            Reference: generated UniqueId + "Your Name"
          </div>
          <label
            style="
              display: flex;
              align-items: flex-start;
              gap: 8px;
              font-weight: 500;
              font-size: 14px;
              cursor: pointer;
            "
          >
            <input type="checkbox" id="paymentAck" required />
            I understand my registration may be cancelled if payment is not
            received within 72 hours.
          </label>
        </div>
        <div class="actions">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="clearDaySelections()"
          >
            Clear Day Selections
          </button>
          <button class="btn" type="submit">Submit Registration</button>
        </div>
        <p class="note" id="backendNote">
          This form stores submissions securely in Firebase Firestore. Use the
          generated ID in your bank transfer reference.
        </p>
      </form>
    </div>
    <footer>
      <p>
        © 2025 debi e.V. All rights reserved. |
        <a href="privacy-statement.html">Privacy Statement</a> |
        <a href="imprint.html">Imprint</a> |
        <a href="satzung.html">Satzung</a> |
        <a href="member-registration.html">Become a Member</a>
      </p>
    </footer>
    <div
      id="notif"
      class="notif-banner"
      role="alert"
      aria-live="assertive"
    ></div>
    <script>
      // Pricing constants (keep in sync with published rates)
      const PRICE_TABLE = {
        adult: { full: 29.99, lunch: 14.99, dinner: 24.99 },
        child: { full: 15.99, lunch: 8.99, dinner: 12.99 },
      };

      function calcTotal() {
        const adults =
          parseInt(document.getElementById("adults").value, 10) || 0;
        const children =
          parseInt(document.getElementById("children").value, 10) || 0;
        let total = 0;
        const days = ["shashti", "saptami", "ashtami", "nabami", "dashami"];
        days.forEach((d) => {
          const val = document.querySelector(`[name="${d}"]`)?.value;
          if (val) {
            total +=
              adults * PRICE_TABLE.adult[val] +
              children * PRICE_TABLE.child[val];
          }
        });
        document.getElementById("totalCost").value = "€" + total.toFixed(2);
      }

      function handleSubmit(e) {
        e.preventDefault();
        // Validate at least one day selected
        const anySelected = [
          "shashti",
          "saptami",
          "ashtami",
          "nabami",
          "dashami",
        ].some((d) => document.querySelector(`[name="${d}"]`)?.value);
        if (!anySelected) {
          showNotification(
            "<strong>Error:</strong> Please select at least one day.",
            "error"
          );
          return;
        }
        // Validate payment policy acknowledgement
        const paymentAck = document.getElementById("paymentAck");
        if (paymentAck && !paymentAck.checked) {
          showNotification(
            "<strong>Error:</strong> Please accept the payment & cancellation policy.",
            "error"
          );
          return;
        }
        calcTotal();
        submitToFirestore(e.target);
      }
      // (Radio buttons handle mutual exclusivity automatically per day via shared names)

      // Attach listeners for dynamic total calculation
      (function initCostListeners() {
        const inputs = [
          ...["shashti", "saptami", "ashtami", "nabami", "dashami"].map((d) =>
            document.querySelector(`[name="${d}"]`)
          ),
          document.getElementById("adults"),
          document.getElementById("children"),
        ].filter(Boolean);
        inputs.forEach((el) => {
          el.addEventListener("change", calcTotal);
          el.addEventListener("input", calcTotal);
        });
      })();

      function clearDaySelections() {
        ["shashti", "saptami", "ashtami", "nabami", "dashami"].forEach((d) => {
          const el = document.querySelector(`[name="${d}"]`);
          if (el) el.value = "";
        });
        calcTotal();
      }

      function generateReferenceId() {
        // fallback if Firestore ID unavailable
        const prefix = "DP2025";
        const core = (
          Date.now().toString(36) + Math.random().toString(36).substring(2, 10)
        )
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "");
        return (prefix + core).substring(0, prefix.length + 8);
      }

      function showNotification(messageHtml, type = "info") {
        const bar = document.getElementById("notif");
        const cls =
          type === "success" ? "success" : type === "error" ? "error" : "";
        bar.className = "notif-banner " + cls;
        bar.innerHTML =
          '<button class="close-btn" aria-label="Close notification" onclick="hideNotification()">×</button>' +
          messageHtml;
        bar.style.display = "block";
        clearTimeout(window.__notifTimer);
        window.__notifTimer = setTimeout(() => hideNotification(), 15000);
      }
      function hideNotification() {
        const bar = document.getElementById("notif");
        bar.style.display = "none";
      }
      // Firebase Firestore integration -----------------------------
      const firebaseConfig = {
        apiKey: "AIzaSyD4pmcZJGPnrks5plPxSxdpUPSfYiB77l0",
        authDomain: "debi-rsvp-2025.firebaseapp.com",
        projectId: "debi-rsvp-2025",
        storageBucket: "debi-rsvp-2025.firebasestorage.app",
        messagingSenderId: "902800968182",
        appId: "1:902800968182:web:bb67a50242c3fc2d945fd7",
        measurementId: "G-44BVW6X39C",
      };
      let _fbReady = false;
      let _fbDeps = null;
      async function ensureFirebase() {
        if (_fbReady) return _fbDeps;
        const [appMod, fsMod] = await Promise.all([
          import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"),
          import(
            "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
          ),
        ]);
        const app = appMod.initializeApp(firebaseConfig);
        const db = fsMod.getFirestore(app);
        _fbDeps = {
          db,
          collection: fsMod.collection,
          addDoc: fsMod.addDoc,
          serverTimestamp: fsMod.serverTimestamp,
        };
        _fbReady = true;
        return _fbDeps;
      }
      async function submitToFirestore(form) {
        try {
          const { db, collection, addDoc, serverTimestamp } =
            await ensureFirebase();
          const formData = new FormData(form);
          const days = {};
          ["shashti", "saptami", "ashtami", "nabami", "dashami"].forEach(
            (d) => {
              const v = document.querySelector(`[name="${d}"]`)?.value;
              if (v) days[d] = v;
            }
          );
          const totalStr =
            document.getElementById("totalCost").value || "€0.00";
          const total = parseFloat(totalStr.replace(/[^0-9.]/g, "")) || 0;
          const payload = {
            firstName: (formData.get("firstName") || "").trim(),
            lastName: (formData.get("lastName") || "").trim(),
            email: (formData.get("email") || "").trim(),
            phone: (formData.get("phone") || "").trim(),
            adults: Number(formData.get("adults")) || 0,
            children: Number(formData.get("children")) || 0,
            children6: Number(formData.get("children6")) || 0,
            food_pref: formData.get("food_pref") || "",
            volunteer: formData.get("volunteer") || "",
            message: formData.get("message") || "",
            days,
            total,
            paymentAck: !!document.getElementById("paymentAck")?.checked,
            createdAt: new Date().toISOString(),
            createdAtServer: serverTimestamp(),
          };
          const col = collection(db, "registrations");
          const docRef = await addDoc(col, payload);
          showNotification(
            `<strong>Registration saved.</strong> Total: <strong>€${total.toFixed(
              2
            )}</strong> | ID: <strong>${
              docRef.id
            }</strong><br /><span style="opacity:.85">Use this ID + your name in the bank transfer reference within 72h.</span>`,
            "success"
          );
          form.reset();
          document.getElementById("totalCost").value = "€0.00";
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (err) {
          console.error(err);
          const fallbackId = generateReferenceId();
          showNotification(
            `<strong>Submission failed:</strong> ${
              err.message || "Unknown error"
            }<br />Temporary reference (not stored): <strong>${fallbackId}</strong>`,
            "error"
          );
        }
      }
    </script>
  </body>
</html>
